rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPERS ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get Real Role from Token Claims (Immutable from Client)
    function getRealRole() {
      // Default to 0 if role claim is missing
      return request.auth.token.role != null ? request.auth.token.role : 0;
    }

    // Get Real TenantId from Token Claims
    function getRealTenantId() {
       return request.auth.token.tenantId;
    }

    function isSuperAdmin() {
      // Robust check: matches number 100, string "100", or legacy "superadmin"
      return isAuthenticated() && (
        getRealRole() >= 100 || 
        request.auth.token.role == "100" ||
        request.auth.token.role == "superadmin"
      );
    }

    function isTenantAdmin(tenantId) {
      return isAuthenticated() && 
             getRealRole() >= 80 && 
             getRealTenantId() == tenantId;
    }

    // --- RULES ---

    // Tenants Collection: Only Superadmins view the master list
    match /tenants/{tenantId} {
      allow read, write: if isSuperAdmin();
    }

    // Projects & Subcollections (Recursive): Strict Multi-tenancy
    // Matches projects/{projectId} AND projects/{projectId}/updates/{updateId}
    match /projects/{document=**} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.tenantId == getRealTenantId());
      
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        (request.resource.data.tenantId == getRealTenantId())
      );
      
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() || 
        (resource.data.tenantId == getRealTenantId() && request.resource.data.tenantId == getRealTenantId())
      );
    }

    // Other Standard Collections (Tasks, Journal, etc): strict multi-tenancy
    match /{collectionName}/{docId} {
      
      // READ: Superadmin Bypass OR matching tenant
      // We assume documents have a 'tenantId' field.
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.tenantId == getRealTenantId());

      // CREATE: 
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        // Standard User: Must write to their OWN tenant
        (request.resource.data.tenantId == getRealTenantId())
      );

      // UPDATE/DELETE:
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() || 
        // Standard User: Can only touch data in their tenant AND ensure it stays in their tenant
        (resource.data.tenantId == getRealTenantId() && request.resource.data.tenantId == getRealTenantId())
      );
    }
    
    // Users Collection: Prevent Admin from seeing other tenants' users
    match /users/{userId} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.tenantId == getRealTenantId());
      
      // Privilege Escalation Check:
      // An Admin (80) cannot create a user with Role >= 80 (or 100) unless logic allows, 
      // but definitively cannot create a Superadmin.
      allow write: if isSuperAdmin() || (request.auth != null && request.auth.uid == userId);
    }
  }
}
