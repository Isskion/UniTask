rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPERS ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Get Real Role: Prefer Token Claim, Fallback to Firestore Profile (Numeric or String)
    function getRealRole() {
      return (request.auth.token != null && 'role' in request.auth.token && (request.auth.token.role == "superadmin" || request.auth.token.role == 100 || request.auth.token.role == "100")) ? 100 :
             (request.auth.token != null && 'role' in request.auth.token && (request.auth.token.role == "app_admin" || request.auth.token.role == 80 || request.auth.token.role == "80")) ? 80 :
             (exists(/databases/$(database)/documents/users/$(request.auth.uid))) ? 
                (getUserData().get('roleLevel', 0) != 0 ? getUserData().roleLevel :
                 (getUserData().get('role', '') == 'superadmin' ? 100 :
                  (getUserData().get('role', '') == 'app_admin' ? 80 :
                   (getUserData().get('role', '') == 'global_pm' ? 60 :
                    (getUserData().get('role', '') == 'consultant' || getUserData().get('role', '') == 'consultor' ? 40 :
                     (getUserData().get('role', '') == 'team_member' ? 20 :
                      (getUserData().get('role', '') == 'client' ? 10 : 0)))))))
             : 0;
    }

    // Get Real TenantId: Prefer Token Claim, Fallback to Firestore Profile
    function getRealTenantId() {
       return (request.auth.token != null && 'tenantId' in request.auth.token)
         ? request.auth.token.tenantId
         : (exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
            ? getUserData().get('tenantId', "unknown") 
            : "unknown");
    }

    function isSuperAdmin() {
      return getRealRole() >= 100;
    }

    // Check if a document's tenant matches the user's tenant (Strict)
    function docTenantMatches(docData) {
      return docData.get('tenantId', null) == getRealTenantId();
    }

    // --- RULES ---

    // Tenants Collection: Only Superadmins view the master list
    match /tenants/{tenantId} {
      allow read, write: if isSuperAdmin();
    }

    // Projects & Subcollections (Recursive): Strict Multi-tenancy
    match /projects/{document=**} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && docTenantMatches(resource.data));
      
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        docTenantMatches(request.resource.data)
      );
      
      allow update: if isAuthenticated() && (
        isSuperAdmin() || 
        (docTenantMatches(resource.data) && docTenantMatches(request.resource.data))
      );

      // Delete: Only App Admins (Level >= 80) or SuperAdmins
      allow delete: if isAuthenticated() && (
        isSuperAdmin() || 
        (docTenantMatches(resource.data) && getRealRole() >= 80)
      );
    }

    // --- [HARDENED] INVITES RULES ---
    // VULN-001 Fix: Disable LIST access. Only allow GET by known code.
    match /invites/{code} {
      // Allow reading specific invite if you know the code
      allow get: if isAuthenticated();
      
      // DENY listing all invites to prevent leakage
      allow list: if false; 

      // Allow creating invites:
      // 1. SuperAdmins always allowed (kept for legacy/dashboard direct access if needed, but safer to block all)
      // 2. Auth users DENIED. Must use Server Action.
      allow create: if false; // LOCKED DOWN. Use Server Action (Admin SDK).
      
      // Allow user to mark as used (consume invite)
      allow update: if isAuthenticated() && (
        // Only allow changing these specific fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isUsed', 'usedBy', 'usedAt'])
      );
    }

    // Notifications: User-specific
    match /notifications/{notificationId} {
        allow read, write: if isAuthenticated() && (resource.data.userId == request.auth.uid || isSuperAdmin());
        allow create: if isAuthenticated() && (
            request.resource.data.userId == request.auth.uid || 
            isSuperAdmin() ||
            (request.resource.data.type == 'system' && request.resource.data.tenantId == "1")
        );
    }

    // Support Tickets
    match /support_tickets/{ticketId} {
        allow create: if isAuthenticated();
        allow read: if isSuperAdmin();
        allow write: if isSuperAdmin();
    }

    // Tasks Rules
    match /tasks/{taskId} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && docTenantMatches(resource.data));
      
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        docTenantMatches(request.resource.data)
      );

      // Update: Tenant Members can update (status, etc)
      allow update: if isAuthenticated() && (
        isSuperAdmin() || 
        (docTenantMatches(resource.data) && docTenantMatches(request.resource.data))
      );
      
      // Delete: Only Creator or Admin (Level >= 80)
      allow delete: if isAuthenticated() && (
        isSuperAdmin() || 
        (docTenantMatches(resource.data) && (
            resource.data.createdBy == request.auth.uid || 
            getRealRole() >= 80
        ))
      );
    }

    // --- [HARDENED] AUDIT LOGS ---
    // VULN-002 Fix: Immutable logs. No Update/Delete allowed.
    match /task_activities/{activityId} {
      allow read: if isAuthenticated(); // Visible to team
      allow create: if isAuthenticated(); // Allow logging actions
      allow update, delete: if false; // IMMUTABLE: Security Requirement
    }

    // Users Collection
    match /users/{userId} {
      allow get: if (request.auth != null && request.auth.uid == userId) || isSuperAdmin();
      allow list: if isSuperAdmin() || 
                  (isAuthenticated() && docTenantMatches(resource.data));
      allow write: if (request.auth != null && request.auth.uid == userId) || isSuperAdmin();
    }

    // --- ENTRIES & STORAGE ---

    // Journal Entries (Daily)
    match /journal_entries/{entryId} {
      allow read, write: if isSuperAdmin() || 
                  (isAuthenticated() && docTenantMatches(resource.data));
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        docTenantMatches(request.resource.data)
      );
    }

    // Weekly Entries (Legacy)
    match /weekly_entries/{entryId} {
      allow read, write: if isSuperAdmin() || 
                  (isAuthenticated() && docTenantMatches(resource.data));
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        docTenantMatches(request.resource.data)
      );
    }

    // --- MASTER DATA & CONFIG ---

    // Master Data (Priorities, Areas, etc)
    match /master_data/{itemId} {
      allow read: if isAuthenticated() && (isSuperAdmin() || docTenantMatches(resource.data));
      allow write: if isAuthenticated() && (isSuperAdmin() || (docTenantMatches(resource.data) && getRealRole() >= 70));
      allow create: if isAuthenticated() && (isSuperAdmin() || (docTenantMatches(request.resource.data) && getRealRole() >= 70));
    }

    // Attribute Definitions (Custom Blocks)
    match /attribute_definitions/{attrId} {
      allow read: if isAuthenticated() && (isSuperAdmin() || docTenantMatches(resource.data));
      allow write: if isAuthenticated() && (isSuperAdmin() || (docTenantMatches(resource.data) && getRealRole() >= 70));
      allow create: if isAuthenticated() && (isSuperAdmin() || (docTenantMatches(request.resource.data) && getRealRole() >= 70));
    }

    // Permission Groups
    match /permission_groups/{groupId} {
      allow read: if isAuthenticated() && (isSuperAdmin() || docTenantMatches(resource.data));
      allow write: if isSuperAdmin() || (isAuthenticated() && docTenantMatches(resource.data) && getRealRole() >= 80);
      allow create: if isSuperAdmin() || (isAuthenticated() && docTenantMatches(request.resource.data) && getRealRole() >= 80);
    }
    
    // REMOVED VULN-003: Wildcard match /{collectionName}/{docId} deleted.
  }
}
