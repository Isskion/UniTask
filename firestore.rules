rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPERS ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    // --- HELPERS WITH FALLBACK ---

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Get Real Role: Prefer Token Claim, Fallback to Firestore Profile
    function getRealRole() {
      let tokenRole = request.auth.token.get('role', null);
      return tokenRole != null 
        ? tokenRole 
        : (exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? getUserData().roleLevel : 0);
    }

    // Get Real TenantId: Prefer Token Claim, Fallback to Firestore Profile
    function getRealTenantId() {
       let tokenTenant = request.auth.token.get('tenantId', null);
       return tokenTenant != null 
         ? tokenTenant 
         : (exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? getUserData().tenantId : null);
    }

    function isSuperAdmin() {
      return isAuthenticated() && (
        getRealRole() >= 100 || 
        request.auth.token.role == "100" ||
        request.auth.token.role == "superadmin"
      );
    }

    function isTenantAdmin(tenantId) {
      return isAuthenticated() && 
             getRealRole() >= 80 && 
             getRealTenantId() == tenantId;
    }

    // --- RULES ---

    // Tenants Collection: Only Superadmins view the master list
    match /tenants/{tenantId} {
      allow read, write: if isSuperAdmin();
    }

    // Projects & Subcollections (Recursive): Strict Multi-tenancy
    // Matches projects/{projectId} AND projects/{projectId}/updates/{updateId}
    match /projects/{document=**} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.tenantId == getRealTenantId());
      
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        (request.resource.data.tenantId == getRealTenantId())
      );
      
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() || 
        (resource.data.tenantId == getRealTenantId() && request.resource.data.tenantId == getRealTenantId())
      );
    }

    // --- NEW: INVITES RULES ---
    // Explicitly allow handling invites despite lack of tenantId claims
    match /invites/{code} {
      allow read: if isAuthenticated();
      // Allow user to mark as used
      allow update: if isAuthenticated();
      allow create: if isSuperAdmin() || isAuthenticated(); // Allow any auth user to create invites (controlled by UI)
    }

    // Notifications: User-specific
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isSuperAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isSuperAdmin());
      allow delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || isSuperAdmin());
    }

    // Explicit Tasks Rules (Clarification for non-superadmins)
    match /tasks/{taskId} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.tenantId == getRealTenantId());
      
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        (request.resource.data.tenantId == getRealTenantId())
      );

      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() || 
        (resource.data.tenantId == getRealTenantId() && request.resource.data.tenantId == getRealTenantId())
      );
    }

    // Other Standard Collections (Tasks, Journal, etc): strict multi-tenancy
    match /{collectionName}/{docId} {
      
      // READ: Superadmin Bypass OR matching tenant
      // We assume documents have a 'tenantId' field.
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.tenantId == getRealTenantId());

      // CREATE: 
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        // Standard User: Must write to their OWN tenant
        (request.resource.data.tenantId == getRealTenantId())
      );

      // UPDATE/DELETE:
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() || 
        // Standard User: Can only touch data in their tenant AND ensure it stays in their tenant
        (resource.data.tenantId == getRealTenantId() && request.resource.data.tenantId == getRealTenantId())
      );
    }
    
    // Users Collection: Prevent Admin from seeing other tenants' users
    match /users/{userId} {
      // ALLOW READ SELF (Fixes "Chicken and Egg" - recursion avoidance: Check ID FIRST)
      allow get: if (request.auth != null && request.auth.uid == userId) || isSuperAdmin();

      // LIST: Restricted to tenant
      allow list: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.tenantId == getRealTenantId());
      
      // WRITE: Self-edit or SuperAdmin
      allow write: if (request.auth != null && request.auth.uid == userId) || isSuperAdmin();
    }
  }
}
