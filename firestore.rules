rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPERS ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Get Real Role: Prefer Token Claim, Fallback to Firestore Profile
    function getRealRole() {
      let tokenRole = request.auth.token.get('role', null);
      return tokenRole != null 
        ? tokenRole 
        : (exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? getUserData().roleLevel : 0);
    }

    // Get Real TenantId: Prefer Token Claim, Fallback to Firestore Profile
    function getRealTenantId() {
       let tokenTenant = request.auth.token.get('tenantId', null);
       return tokenTenant != null 
         ? tokenTenant 
         : (exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? getUserData().tenantId : null);
    }

    function isSuperAdmin() {
      return isAuthenticated() && (
        getRealRole() >= 100 || 
        request.auth.token.role == "100" ||
        request.auth.token.role == "superadmin"
      );
    }

    // --- RULES ---

    // Tenants Collection: Only Superadmins view the master list
    match /tenants/{tenantId} {
      allow read, write: if isSuperAdmin();
    }

    // Projects & Subcollections (Recursive): Strict Multi-tenancy
    match /projects/{document=**} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.tenantId == getRealTenantId());
      
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        (request.resource.data.tenantId == getRealTenantId())
      );
      
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() || 
        (resource.data.tenantId == getRealTenantId() && request.resource.data.tenantId == getRealTenantId())
      );
    }

    // --- [HARDENED] INVITES RULES ---
    // VULN-001 Fix: Disable LIST access. Only allow GET by known code.
    match /invites/{code} {
      // Allow reading specific invite if you know the code
      allow get: if isAuthenticated();
      
      // DENY listing all invites to prevent leakage
      allow list: if false; 

      // Allow creating invites:
      // 1. SuperAdmins always allowed
      // 2. Auth users allowed (but logic constraints handled in app code + basic validation)
      allow create: if isAuthenticated();
      
      // Allow user to mark as used (consume invite)
      allow update: if isAuthenticated() && (
        // Only allow changing these specific fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isUsed', 'usedBy', 'usedAt'])
      );
    }

    // Notifications: User-specific
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated() && (resource.data.userId == request.auth.uid || isSuperAdmin());
      allow create: if isAuthenticated() && (request.resource.data.userId == request.auth.uid || isSuperAdmin());
    }

    // Tasks Rules
    match /tasks/{taskId} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.tenantId == getRealTenantId());
      
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        (request.resource.data.tenantId == getRealTenantId())
      );

      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() || 
        (resource.data.tenantId == getRealTenantId() && request.resource.data.tenantId == getRealTenantId())
      );
    }

    // --- [HARDENED] AUDIT LOGS ---
    // VULN-002 Fix: Immutable logs. No Update/Delete allowed.
    match /task_activities/{activityId} {
      allow read: if isAuthenticated(); // Visible to team
      allow create: if isAuthenticated(); // Allow logging actions
      allow update, delete: if false; // IMMUTABLE: Security Requirement
    }

    // Users Collection
    match /users/{userId} {
      allow get: if (request.auth != null && request.auth.uid == userId) || isSuperAdmin();
      allow list: if isSuperAdmin() || 
                  (isAuthenticated() && resource.data.tenantId == getRealTenantId());
      allow write: if (request.auth != null && request.auth.uid == userId) || isSuperAdmin();
    }
    
    // REMOVED VULN-003: Wildcard match /{collectionName}/{docId} deleted.
  }
}
