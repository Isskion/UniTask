rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPERS ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Get Real Role: Prefer UID/Email Bypass (Dev Only), then Token Claims, then Firestore Document
    function getRealRole() {
      return (request.auth != null && (request.auth.uid == "6C9ZN0mfngNb5gIAWw1EMSaQcRR2" || request.auth.uid == "v7S0Xo8o9xO3Vb2n3m5G" || request.auth.token.email == "argoss01@gmail.com")) ? 100 :
             (request.auth.token != null && 'roleLevel' in request.auth.token && int(request.auth.token.roleLevel) > 0) ? int(request.auth.token.roleLevel) :
             (exists(/databases/$(database)/documents/users/$(request.auth.uid))) ? 
                (int(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('roleLevel', 0)) > 0 
                  ? int(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('roleLevel', 0)) 
                  : (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == 'superadmin' ? 100 
                    : (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == 'app_admin' ? 80 
                      : (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == 'global_pm' ? 60 : 0))))
             : 0;
    }

    // Get Real TenantId: Prefer Token Claim, Fallback to Firestore Profile (Always String)
    function getRealTenantId() {
       return (request.auth.token != null && 'tenantId' in request.auth.token)
         ? string(request.auth.token.tenantId)
         : (exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
            ? string(get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('tenantId', "unknown")) 
            : "unknown");
    }

    function isSuperAdmin() {
      return getRealRole() >= 100;
    }

    // Check if a document's tenant matches the user's tenant (Type-Safe String Comparison)
    function docTenantMatches(docData) {
      return string(docData.get('tenantId', 'ERROR')) == getRealTenantId();
    }

    // --- RULES ---

    // Tenants Collection: Only Superadmins view the master list
    match /tenants/{tenantId} {
      allow read, write: if isSuperAdmin();
    }

    // Projects & Subcollections (Recursive): Strict Multi-tenancy
    match /projects/{document=**} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && docTenantMatches(resource.data));
      
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        docTenantMatches(request.resource.data)
      );
      
      allow update: if isAuthenticated() && (
        isSuperAdmin() || 
        (docTenantMatches(resource.data) && docTenantMatches(request.resource.data))
      );

      // Delete: Only App Admins (Level >= 80) or SuperAdmins
      allow delete: if isAuthenticated() && (
        isSuperAdmin() || 
        (docTenantMatches(resource.data) && getRealRole() >= 80)
      );
    }

    // --- [HARDENED] INVITES RULES ---
    match /invites/{code} {
      allow get: if isAuthenticated();
      allow list: if false; 
      allow create: if false; 
      allow update: if isAuthenticated() && (
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isUsed', 'usedBy', 'usedAt'])
      );
    }

    // Notifications: User-specific
    match /notifications/{notificationId} {
        allow read, write: if isAuthenticated() && (resource.data.userId == request.auth.uid || isSuperAdmin());
        allow create: if isAuthenticated() && (
            request.resource.data.userId == request.auth.uid || 
            request.resource.data.type == 'mention' ||
            request.resource.data.type == 'assignment' ||
            isSuperAdmin() ||
            (request.resource.data.type == 'system' && request.resource.data.tenantId == "1")
        );
    }

    // Support Tickets
    match /support_tickets/{ticketId} {
        allow create: if isAuthenticated();
        allow read: if isSuperAdmin();
        allow write: if isSuperAdmin();
    }

    // Tasks Rules
    match /tasks/{taskId} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && docTenantMatches(resource.data));
      
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        docTenantMatches(request.resource.data)
      );

      allow update: if isAuthenticated() && (
        isSuperAdmin() || 
        (docTenantMatches(resource.data) && docTenantMatches(request.resource.data))
      );
      
      allow delete: if isAuthenticated() && (
        isSuperAdmin() || 
        (docTenantMatches(resource.data) && (
            resource.data.createdBy == request.auth.uid || 
            getRealRole() >= 80
        ))
      );
    }

    // Task Comments
    match /task_comments/{commentId} {
      allow read: if isSuperAdmin() || 
                  (isAuthenticated() && docTenantMatches(resource.data));
      
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        docTenantMatches(request.resource.data)
      );
    }

    // --- [HARDENED] AUDIT LOGS ---
    match /task_activities/{activityId} {
      allow read: if isAuthenticated(); 
      allow create: if isAuthenticated(); 
      allow update, delete: if false; 
    }

    // Users Collection
    match /users/{userId} {
      allow get: if (request.auth != null && request.auth.uid == userId) || isSuperAdmin();
      allow list: if isSuperAdmin() || 
                  (isAuthenticated() && docTenantMatches(resource.data));
      allow write: if (request.auth != null && request.auth.uid == userId) || isSuperAdmin();
    }

    // --- ENTRIES & STORAGE ---

    match /journal_entries/{entryId} {
      allow read, write: if isSuperAdmin() || 
                  (isAuthenticated() && docTenantMatches(resource.data));
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        docTenantMatches(request.resource.data)
      );
    }

    match /weekly_entries/{entryId} {
      allow read, write: if isSuperAdmin() || 
                  (isAuthenticated() && docTenantMatches(resource.data));
      allow create: if isAuthenticated() && (
        isSuperAdmin() || 
        docTenantMatches(request.resource.data)
      );
    }

    // --- MASTER DATA & CONFIG ---

    match /master_data/{itemId} {
      allow read: if isAuthenticated() && (isSuperAdmin() || docTenantMatches(resource.data));
      allow write: if isAuthenticated() && (isSuperAdmin() || (docTenantMatches(resource.data) && getRealRole() >= 60));
      allow create: if isAuthenticated() && (isSuperAdmin() || (docTenantMatches(request.resource.data) && getRealRole() >= 60));
    }

    match /attribute_definitions/{attrId} {
      allow read: if isAuthenticated() && (isSuperAdmin() || docTenantMatches(resource.data));
      allow write: if isAuthenticated() && (isSuperAdmin() || (docTenantMatches(resource.data) && getRealRole() >= 60));
      allow create: if isAuthenticated() && (isSuperAdmin() || (docTenantMatches(request.resource.data) && getRealRole() >= 60));
    }

    match /permission_groups/{groupId} {
      allow read: if isAuthenticated() && (isSuperAdmin() || docTenantMatches(resource.data));
      allow write: if isSuperAdmin() || (isAuthenticated() && docTenantMatches(resource.data) && getRealRole() >= 80);
      allow create: if isSuperAdmin() || (isAuthenticated() && docTenantMatches(request.resource.data) && getRealRole() >= 80);
    }
    
    match /export_templates/{templateId} {
      allow read: if isAuthenticated() && (isSuperAdmin() || docTenantMatches(resource.data));
      allow create: if isAuthenticated() && (isSuperAdmin() || docTenantMatches(request.resource.data));
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() || 
        (docTenantMatches(resource.data) && (resource.data.createdBy == request.auth.uid || getRealRole() >= 60))
      );
    }

    match /timeline_events/{eventId} {
      allow read: if isAuthenticated() && (isSuperAdmin() || docTenantMatches(resource.data));
      allow create: if isAuthenticated() && (isSuperAdmin() || docTenantMatches(request.resource.data));
    }
    
    // --- DIAGNOSTIC ---
    match /_diagnostic/{docId} {
      allow read, write: if isAuthenticated();
    }
  }
}
